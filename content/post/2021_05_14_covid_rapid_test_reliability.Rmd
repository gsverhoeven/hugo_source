---
title: "A close examination of the Roche Rapid Antigen Test Nasal: How reliable is it?"
author: "Gertjan Verhoeven"
date: '2021-06-06'
summary: This blog post is about self-administered antigen tests. How reliable are they? I tracked down the data mentioned in the kit's leaflet and did the analysis for myself. 
slug: covid_antigen_test_reliability
draft: no
categories: 
  - Statistics, R, Measurement
tags:
  - COVID-19, DAG, causal graph
baseurl: https://gsverhoeven.github.io
header:
  image: headers/covid_antigen_test.png
  preview: no
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

```{r include = FALSE}
library(tidyverse)
library(yardstick)
```

Many people are suspicious about the reliability of rapid self-tests, so I decided to check it out.
For starters, I LOVE measurement. It is where learning from data starts, with technology involved, and models. 
With this post, I'd like to join the swelling ranks of amateur epidemiologists :) I have spent a few years in a molecular biology lab, that should count for something right? 

At home, we now have a box of the `SARS-CoV-2 Rapid Antigen Test Nasal` kit.
The kit is distributed by Roche, but manufactured in South Korea by a company called SD Biosensor.

So where to start? We can make a small causal model of the measurement process using [DAGitty](http://dagitty.net/dags.html?id=whqGBx):

```{r echo = FALSE, fig.width=8, fig.height = 3}
library(dagitty)

g <- dagitty('dag {
bb="0,0,1,1"
"throat+deep_nose_swab" [pos="0.464,0.257"]
Infected [exposure,pos="0.179,0.250"]
antigen_test [outcome,pos="0.550,0.449"]
close_contact_with_infected [pos="0.335,0.451"]
decision_to_test [pos="0.394,0.357"]
nose_swab [pos="0.463,0.451"]
pcr_test [outcome,pos="0.548,0.257"]
symptoms [pos="0.332,0.251"]
virus_buildup [pos="0.261,0.249"]
"throat+deep_nose_swab" -> pcr_test
Infected -> virus_buildup
close_contact_with_infected -> decision_to_test
decision_to_test -> "throat+deep_nose_swab"
decision_to_test -> nose_swab
nose_swab -> antigen_test
symptoms -> decision_to_test
virus_buildup -> symptoms
}

')

plot(g)
```

It all starts with whether someone is infected. After infection, virus particles start to build up. These particles can be in the lungs, in the throat, nose etc. 
These particles either do or do not cause symptoms. Whether there are symptoms will likely influence the decision to test, but there will also be people without symptoms that will be tested (i.e. if a family member was tested positive).

In the experiments we analyse, two samples were taken, one for the PCR test and one for the antigen test.

To do the PCR test you need a lab with skilled people, equipment such as PCR devices and pipets, and some time, as the process takes at least a few hours to complete.
The advantage of an antigen test, such as the kit from Roche, is to have a low-tech, faster alternative that can be self-administered.
But that comes at a cost, because the antigen tests are less sensitive.
How much less? Lets find out.

# Information on the leaflet

The leaflet contains information on the **sensitivity** (does it detect COVID when you are infected) and **specificity** of the test
(does it ONLY detect COVID, or also other flu types or even unrelated materials). 

* Sensitivity 83.3% (95%CI: 74.7% - 90.0%)
* Specificity 99.1% (95%CI: 97.7% - 99.7%)

But what does this really tell us? And where do these numbers come from?

According to the leaflet, this data came from three experiments on samples from in total 547 persons. After googling a bit, I found out that the experiments were performed by independent researchers in a famous University hospital in Berlin, [CharitÃ©](https://de.wikipedia.org/wiki/Charit%C3%A9). After googling a bit more and mailing with one of the researchers involved, Prof. Andreas Lindner, I received a list of papers that describe the research mentioned in the leaflet (References at the end of this post).

# Viral load as target for measurement

As already mentioned, both tests work by detecting viral particles in a particular sample. The amount of virus particles present in the sample depends on, for example:

* Time since infection
* How and where the sample is taken (throat, nose, lungs, using a swab etc)

I'll discuss both.

## Time since infection

When you have just been infected, your body will contain only a small amount of virus.
The **viral load** is a function of time since infection, because it takes time for the virus to multiply itself. Even PCR cannot detect an infection on the first day, and even after 8 days, there are still some 20% of cases that go undetected by PCR (presumably because the amount of viral particle is too low) (Ref: Kucirka et al 2020).

If you want to know more about the ability of PCR to detect COVID infections go check out [the covidRTPCR Github repository](https://github.com/HopkinsIDD/covidRTPCR). It is completely awesome, with open data, open code, and Bayesian statistics using [Stan](https://mc-stan.org/)!

## How and where the sample is taken

There are many ways to obtain a sample from a person.

Here the golden standard is a so-called  **Nasopharyngeal swab**. This goes through your nose all the way (~ 5 cm) into the back of the throat, and is highly uncomfortable. Typically, only professional health workers perform **nasopharyngeal** swabs.
In these experiments, this deep nose swab was combined with a swab from the throat (**oroharyngeal**). This is also how test centers in the Netherlands operated during the last year.

There are various alternatives: We have spit, saliva, we can cough up "sputum" (slime from the lungs) or we can take swab from the front part of the nose ("nasal"). 

The Roche antigen test is a **nasal** test that only goes up to 2 cm in the nose and can be used by patients themselves ("self-collected"). 

# The dataset: results from the three Berlin studies

Now that we have some background info, we are ready to check the data!

The dataset for the blog post compares **nasal** samples tested with the Roche Antigen test kit, to PCR-tested **nasopharyngeal** plus **oropharyngeal** samples taken by professionals. 

**This blog post is possible because the three papers by Lindner and co-workers all contain the raw data as a table in the paper. Cool!**
Unfortunately, this means the data is not **machine readable**. However, with a combination of manual tweaking / find-replace and some coding, I tidied the data of the three studies into a single `tibble` data frame. You can grab the code and data from my [Github](https://github.com/gsverhoeven/hugo_source/tree/master/content/post/sars_test).

```{r}
# creates df_pcr_pos
source("sars_test/dataprep_roche_test.R")

# creates df_leaflet
source("sars_test/dataprep_roche_test_leaflet.R")

# see below
source("sars_test/bootstrap_conf_intervals.R")
```

The dataset `df_pcr_pos` contains, for each **PCR positive** patient:

* `ct_value`
* `viral_load` 
* `days_of_symptoms`
* `mm_value` (Result of the antigen test measurement, 1 is positive, 0 is negative)

To understand the PCR data, we need to know a bit more about the PCR method.

## The PCR method

The PCR method not only measures **if** someone is infected, it also provides an estimate of the viral load in the sample.
How does this work? PCR can amplify, in so-called cycles, really low quantities of viral material in a biological sample. The amount of cycles of the PCR device needed to reach a threshold of signal is called the cycle threshold or **Ct value**. The less material we have in our sample, the more cycles we need to amplify the signal to reach a certain threshold. 

Because the amplification is an exponential process, if we take the log of the number of virus particles, we get a linear inverse (negative) relationship between **ct_value** and **viral_load**. For example, $10^6$ particles is a viral load of 6 on the log10 scale.

So let's plot the `ct_value` of the PCR test vs the `viral_load`:

```{r}
set.seed(123)
ggplot(df_pcr_pos, aes(x = ct_value, y = viral_load, color = factor(pcr_assay_type))) + 
  geom_point() + ggtitle("Calibration curves for viral load (log10 scale)")

```
This plot shows that `viral_load` is directly derived from the `ct_value` through a calibration factor.
PCR Ct values of > 35 are considered as the threshold value for detecting a COVID infection using the PCR test, so the values in this plot make sense for COVID positive samples.

Take some time to appreciate the huge range difference in the samples on display here.
From only 10.000 viral particles ($log_{10}{(10^4)} = 4$ ) to almost 1 billion ($log_{10}{(10^9)} = 9$ ) particles.

We can also see that apparently, there were two separate PCR assays (test types), each with a separate conversion formula used to obtain the estimated viral load.

(**N.b.** The missings for `pcr_assay_type` are because for two of three datasets, it was difficult to extract this information from the PDF file. From the plot, we can conclude that for these datasets, the same two assays were used since the values map onto the same two calibration lines)

## Sensitivity of the Antigen test

The dataset contains all samples for which the PCR test was positive.
Let's start by checking the raw percentage of antigen test measurements that are positive as well. 
This is called the **sensitivity** of a test.

```{r}
res <- df_pcr_pos %>%
  summarize(sensitivity = mean(mm_value), 
            N = n())

res
```
So for all PCR positive samples, `r round(res$sensitivity * 100, 1)` % is positive as well.
This means that, on average, if we would use the antigen test kit, we have a one in five (20%) probability of not detecting COVID-19, compared to when we would have used the method used by test centers operated by the public health agencies.

This value is slightly lower, but close to what is mentioned in the Roche kit's leaflet.

Let's postpone evaluation of this fact for a moment and look a bit closer at the data.
For example, we can example the relationship between `viral_load` and a positive antigen test result (`mm_value` = 1):

```{r}
set.seed(123)
ggplot(df_pcr_pos, aes(x = viral_load, y = mm_value)) + 
  geom_jitter(height = 0.1) +
  geom_smooth() + 
  geom_vline(xintercept = c(5.7, 7), col = "red")
```
From this plot, we can see that the probability of obtaining a false negative result (`mm_value` of 0) on the antigen test decreases as the viral load *of the PCR sample* increases. 

From the data we also see that before the antigen test to work about half of the time (blue line at 0.5), the PCR sample needs to contain around $5 \cdot 10^5$ viral particles (log10 scale 5.7), and for it to work reliably, we need around $10^7$ particles ("high" viral load) in the PCR sample (which is a combination of **oropharyngeal and nasopharyngeal swab**). This last bit is important: the researchers did not measure the viral load in the nasal swabs used for the antigen test, these could well be lower/ different. 

For really high viral loads, above $10^7$ particles in the **NP/OP sample**, the probability of a false negative result is only a few percent:

```{r}
df_pcr_pos %>% filter(viral_load >= 7) %>%
  summarize(sensitivity = mean(mm_value), 
            N = n())
```

# Viral loads varies with days of symptoms

Above, we already discussed that the viral load varies with the time since infection.

If we want to use the antigen test **instead** of taking a PCR test, we don't have information on the viral load. What we often do have is the days since symptoms, and we know that in the first few days of symptoms viral load is highest. 

We can check this by plotting the `days_of_symptoms` versus `viral_load`:

```{r}
ggplot(df_pcr_pos, aes(x = days_of_symptoms, y = viral_load)) + 
  geom_smooth() + expand_limits(x = -4) + geom_vline(xintercept = 1, linetype = "dashed") +
  geom_vline(xintercept = c(3, 7), col = "red") + geom_hline(yintercept = 7, col = "grey", linetype = "dashed") +
  geom_jitter(height = 0, width = 0.2) 

```
From this plot, we learn that the viral load is highest on the onset of symptoms day (typically 5 days after infection) and decreases afterwards. 

Above, we saw that the sensitivity in the whole sample was not equal to the sensitivity mentioned in the leaflet.
When evaluating rapid antigen tests, sometimes thresholds for days of symptoms are used, for example <= 3 days or <= 7 days (plotted in red). 

For the sensitivity in the leaflet, a threshold of <= 7 days was used on the days of symptoms.

Let us see how sensitive the antigen test is for these subgroups:

```{r}
res <- df_pcr_pos %>%
  filter(days_of_symptoms <= 3) %>%
  summarize(label = "< 3 days",
            sensitivity = mean(mm_value), 
            N = n())

res2 <- df_pcr_pos %>%
  filter(days_of_symptoms <= 7) %>%
  summarize(label = "< 7 days",
            sensitivity = mean(mm_value), 
            N = n())

bind_rows(res, res2)
```
The sensitivity in both subgroups is increased to `r round(res$sensitivity * 100, 1)` % and `r round(res2$sensitivity * 100, 1)` %.
Now only 1 in 7 cases is missed by the antigen test. 
This sensitivity is now very close to that in the leaflet. The dataset in the leaflet has N = 102, whereas here we have N = 100.
Given that the difference is very small, I decided to not look into this any further.

# Nasal vs nasopharyngeal swabs

There exists also a version of the Roche kit that uses nasopharyngeal swabs.
A recent Dutch study, with samples from a test center in Rotterdam, used this kit (ref: Igloi et al 2021).
For the subset of samples with high viral load (ct_value < 30) **AND** who presented within 7 days of symptom onset, they found a sensitivity of 95.8% (CI95% 90.5-98.2).

We can check what the sensitivity is for this subgroup in the Berlin dataset:

```{r}
df_pcr_pos %>% filter(viral_load >= 5 & days_of_symptoms <= 7) %>%
  summarize(sensitivity = mean(mm_value), 
            N = n())
```

The sensitivity of the nasal swab test is 7% lower (ignoring statistical uncertainty).

These results are consistent with a recent systematic review study by Lee et al, who find that

*Three specimen types captured lower % positives (Nasal Swabs [82%, 95% CI: 73 to 90%], oropharyngeal swabs [84%, 95% CI: 57 to 100%], and saliva [88%, 95% CI: 81 to 93%]) than nasopharyngeal swabs*

This is important to realize: a sizeable portion of the reduction in sensitivity is caused by the way the sample is taken, not by using a different measurement technique!

# Specificity

So far, the discussion centered around the **sensitivity** of the test.
Equally important is the **specificity** of the test. This quantifies if the test result of the antigen test is specific for COVID-19. It would be bad if the test would also show a result for other viruses, or even unrelated molecules.

To examine this, we use the aggregated data supplied on the leaflet from the kit, `df_leaflet`.

**N.b.** The data from the leaflet is a subset of all the data from the three studies, because the data was subsetted for cases with `<= 7 days_of_symptoms`. 

This dataset contains for each sample one of four possibilities:

* Both tests are negative, 
* both tests are positive, 
* the PCR test is positive but the antigen test negative, 
* the PCR test is negative but the antigen positive.

We use the `yardstick` package of R's `tidymodels` family to create the 2x2 table and analyze the specificity.

(**Overthinking**: Note that the `yardstick` package is used to quantify the performance of statistical prediction models by comparing the model predictions to the true values contained in the training data. This provides us with an analogy where the antigen test can be viewed as a model that is trying the predict the outcome of the PCR test.)

```{r fig.width = 3, fig.height = 3}
options(yardstick.event_first = FALSE)

conf_matrix <- yardstick::conf_mat(df_leaflet, pcr_result, ag_result)

autoplot(conf_matrix, 
         type = "heatmap", 
         title = "Truth = PCR test, Prediction = Antigen test")
```
From the heatmap (confusingly called a confusion matrix), we see that:

* For most samples (N = 431), both tests are COVID-19 negative.
* 85 + 17 = 102 samples tested COVID-19 positive using the PCR-test
* 85 out of 102 samples that are PCR positive, are antigen test positive as well

For the specificity, we have to look at the samples where the PCR test is negative, but the antigen test is positive, and compare these to all the samples that are PCR-test negative. These are the number of tests where the antigen test picked up a non-specific signal. One minus this percentage gives the specificity (1 - 4/435 = 431/435):

```{r}
yardstick::spec(df_leaflet, pcr_result, ag_result)
```

Thus, we find that the antigen test is highly specific, with around 1% of false positives.

# Specificity and Sensitivity: credible intervals consistent with the data

So far, we did not discuss the sampling variability in the estimated specificity and sensitivity.

The kit leaflet mentions the following confidence intervals:

* Sensitivity 83.3% (95%CI: 74.7% - 90.0%)
* Specificity 99.1% (95%CI: 97.7% - 99.7%)

The R-package `yardstick` does not yet include confidence intervals, so I generated these using bootstrapping. I calculate both metrics for 10.000 samples sampled from the raw data. For brevity I omitted the code here, go check out my [Github](https://github.com/gsverhoeven/hugo_source/tree/master/content/post/sars_test) for the R script.

The bootstrapping approach yields the following range of plausible values given the data (95% interval):

```{r}
quantile(spec_vec, probs = c(0.025, 0.975))
quantile(sens_vec, probs = c(0.025, 0.975))
```

The amount of data (N = 537) prevents us from getting an exact match to the leaflet's confidence intervals, that are based on theoretic formulas. But we do get pretty close.

Especially for the sensitivity, there is quite some uncertainty, we see that plausible values range from 76% up to 90% *for this particular cohort of cases with this particular mix of viral loads that showed up during the last four months of 2020 in the University hospital in Berlin*.

# Conclusions

To summarise: we found that the numbers of the kit's leaflet are reliable and published in full detail in the scientific literature.
Hurray! 

We also found that even the gold standard PCR is not able to detect all infected persons, it all depends on how much virus is present, and how the sample is obtained. From the analysis, it is clear that the rapid Antigen tests need more virus present to reliably detect infection. It is ALSO clear that the test is highly specific, with less than 1% false positives. Note that a false positive rate of 1% still means that in a healthy population of 1000, 10 are falsely detected as having COVID-19. 
Finally, we find that the nasal swabs are less sensitive than the nasopharyngeal ("deep nose") swabs, this reduces sensitivity by roughly 10% (Lindner *et al.* 2021, Igloi *et al.* 2021, Lee *et al.* 2021). 

So both the measurement device, and the self-collection of sample contribute to reduce the sensitivity. But now comes the key insight: the persons that produce the largest amounts of virus get detected, irrespective of whether they have symptoms or not. To me, this seems like a "Unique Selling Point" of the rapid tests: the ability to rapidly detect the most contagious persons in a group, after which these persons can go into quarantine and help reduce spread.

# References

* Head-to-head comparison of SARS-CoV-2 antigen-detecting rapid test with self-collected nasal swab versus professional-collected nasopharyngeal swab
Andreas K. Lindner, Olga Nikolai, Franka Kausch, Mia Wintel, Franziska Hommes, Maximilian Gertler, Lisa J. KrÃ¼ger, Mary Gaeddert, Frank Tobian, Federica Lainati, Lisa KÃ¶ppel, Joachim Seybold, Victor M. Corman, Christian Drosten, JÃ¶rg Hofmann, Jilian A. Sacks, Frank P. Mockenhaupt, Claudia M. Denkinger, [European Respiratory Journal 2021 57: 2003961](https://erj.ersjournals.com/content/57/4/2003961)

* Head-to-head comparison of SARS-CoV-2 antigen-detecting rapid test with professional-collected nasal versus nasopharyngeal swab
Andreas K. Lindner, Olga Nikolai, Chiara Rohardt, Susen Burock, Claudia HÃ¼lso, Alisa BÃ¶lke, Maximilian Gertler, Lisa J. KrÃ¼ger, Mary Gaeddert, Frank Tobian, Federica Lainati, Joachim Seybold, Terry C. Jones, JÃ¶rg Hofmann, Jilian A. Sacks, Frank P. Mockenhaupt, Claudia M. Denkinger [European Respiratory Journal 2021 57: 2004430](https://erj.ersjournals.com/content/57/5/2004430)

* SARS-CoV-2 patient self-testing with an antigen-detecting rapid test: a head-to-head comparison with professional testing
Andreas K. Lindner, Olga Nikolai, Chiara Rohardt, Franka Kausch, Mia Wintel, Maximilian Gertler, Susen Burock, Merle HÃ¶rig, Julian Bernhard, Frank Tobian, Mary Gaeddert, Federica Lainati, Victor M. Corman, Terry C. Jones, Jilian A. Sacks, Joachim Seybold, Claudia M. Denkinger, Frank P. Mockenhaupt, under review, [preprint on medrxiv.org](https://www.medrxiv.org/content/10.1101/2021.01.06.20249009v1)

* Variation in False-Negative Rate of Reverse Transcriptase Polymerase Chain ReactionâBased SARS-CoV-2 Tests by Time Since Exposure: Lauren M. Kucirka, Stephen A. Lauer, Oliver Laeyendecker, Denali Boon, Justin Lessler [Link to paper](https://www.acpjournals.org/doi/full/10.7326/M20-1495)

* Clinical  evaluation  of  the  Roche/SD  Biosensor  rapid  antigen  test  with  symptomatic,  non-hospitalized patients in a municipal health service drive-through testing site. 
Zsá½fia Iglá½i, Jans Velzing, Janko van Beek, David van de Vijver, Georgina Aron,  Roel Ensing, KimberleyBenschop,    Wanda   Han,    Timo   Boelsums,   Marion   Koopmans,    Corine   Geurtsvankessel,   Richard   Molenkamp [Link on medrxiv.org](https://www.medrxiv.org/content/10.1101/2020.11.18.20234104v1)

* Performance of Saliva, Oropharyngeal Swabs, and Nasal Swabs for SARS-CoV-2 Molecular Detection: a Systematic Review and Meta-analysis 
Rose A. Lee, Joshua C. Herigona, Andrea Benedetti, Nira R. Pollock, Claudia M. Denkinger [Link to paper](https://journals.asm.org/doi/10.1128/JCM.02881-20)
