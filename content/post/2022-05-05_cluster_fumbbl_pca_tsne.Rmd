---
title: 'Cluster analysis of Blood Bowl teams using FUMBBL data in R: PCA vs T-SNE'
author: "Gertjan Verhoeven"
date: '2022-05-05'
summary: This blog post compares two unsupervised learning methods to learn which Blood Bowl teams are similar. Similarity is quantified by looking atvarious match related metrics from such as scoring, injuries, passes and blocks.
slug: blood-bowl-cluster-analysis
draft: yes
categories:
- Blood Bowl
- Machine Learning
- Clustering
- Unsupervised learning
tags:
- t-sne
- pca
baseurl: https://gsverhoeven.github.io
header:
  image: headers/wilhelm-gunkel-di8ognBauG0-unsplash.png
  preview: no
---

This is my third blog post on Blood Bowl, the game of Fantasy Football. Blood Bowl can be summarized as "chess-with-dice" , but this would hardly do the game justice. For example, in chess both players play with the same pieces, but in Blood Bowl, almost 30 different teams (e.g. orcs, elves, etc) are available to choose from, each team with different skills that require different playing styles. In addition, Blood Bowl coaches must assemble and paint their playing pieces themselves, making it a creative hobby as well.

Using data analysis, we can compare teams on their match performance statistics and see which teams cluster together. From this clustering we might learn something, for example that teams with similar stats might also have a similar play style. Teams can of course still be different on some aspect we did not include in the analysis, but let's just have a look at what we get! 

This post at its heart is basically an update from [this 2018 nufflytics blog post](https://www.nufflytics.com/post/bash-dash-hybrid-by-the-numbers/).
In that blog post, the author used cluster analysis as well as his own domain knowledge to categorize (classify) the different teams in six clusters, depending on their play style as well as performance (chance of winning the game). Since then, there have been changes to the rules, and new teams have been created, such as Imperial Nobility, Khorne, Black Orcs etc. It will be interesting to reproduce the analysis, and see where the new teams end up.

# Team play style divisions

Here we use the following division of team types:

```
https://www.reddit.com/r/bloodbowl/comments/64o8hw/bashy_and_nonbashy_teams/

OCC uses the following system:

Bash: Orcs, Dwarves, Chaos, Chaos Dwarves, Khemri, Nurgle

Agility: Wood, High, Pro, Dark and Skaven

Hybrid: Amazon, Human, Norse, Necro, Undead, Lizard

Non-T1: Pact, Underworld, Slann, (Brets, Khorne, Simyin), Vamps

Stunty: Goblins, Halflings, Ogres

The bottom two are clearly performance-based, but there is an actual method behind the differentiation between Bash, Agi and Hybrid teams. 

If a team has 4+ S(trength) access players but fewer than 4 A(gility) access players it is Bash; 
if it has 4+ A access players but fewer than 4 S access players it is Agi; 
if it has 4 or more of each it is Hybrid.

This might look like Orcs should be hybrid, but they are so rarely played with more than one goblin (and very often with no goblins) so they go in the Bash category.

Brets, Khorne and Simyin are in brackets because their performance isn't as clearly defined. Khorne are intended as a T1.5 team and perform as such, and I believe Brets and Simyin are too. Khorne and Brets would be Hybrid teams and Simyin would be Bash if you wanted them to be categorised as the above are, though
```

I wouldn't class undead as a bashy team. 4 players with ST access (Wights, Mummys) and 4 with AG access (4 Ghouls) makes them a hybrid team.

AndyDavo: Chaos are a bash team, but Undead is hybrid. Zero agility access defines bash. 

Other than Orcs, the other true "bash" teams are Dwarves, Chaos, Chaos Dwarves, Nurgle and perhaps Khemri



# Loading the datasets

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Load packages
library(tidyverse)
library(ggfortify)
library(ggrepel)
```

From the full dataset, we select four groups of Blood Bowl matches to compare: Three divisions (**Blackbox**, **Ranked** and **League**) that used Blood Bowl 2016 rulesets and were active up until september 2020, and the new **Competitive** division that uses the ruleset from the new Blood Bowl 2020 version of the game ("Second Edition").

```{r}
divisions <- c("Competitive", "Blackbox", "Ranked", "League")

filter_division <- function(div_name){
  df_mbt %>% 
  filter(division_name == div_name) %>%
  filter(race_name != "Treeman") %>%
  filter(race_name != "Simyin")
}
```

We starting with reading in the scraped FUMBBL match data, see my previous blog posts for details.

# Race type classification: Bash / Dash / Hybrid

The dataset already contains a categorization into race types.
The common way to group Blood Bowl teams is to look at the balance between access to skills related to Agility (Ball handling) and Strength ("bashing" of the opponent). 

Teams that have no or very little access to Agility skills but have at least four players with strength access are classified as Bash teams.


* Agile
* Bash
* Hybrid
* Stunty ("weak", "difficult to play", "a lot of stunty (very small) players", "big guys with negatrait")
* New (or unknown)
* Other

```{r}
df_mbt <- read.csv(file = "../../../fumbbl_datasets/datasets/current/df_mbt.csv")

race_types <- unique(df_mbt %>% 
                       select(race_name, race_type) %>%
                       filter(race_type != "") %>%
                       arrange(race_type))

race_types
```

Hybrid is negatively defined as "not stunty, not agile, not bash".

```{r}
data_tables <- map(divisions, filter_division)
names(data_tables) <- divisions

select_stats <- function(df) {
  df %>% 
  select(race_name, race_type, team_score, away_team_score:away_cas_rip) %>%
  select(-(home_cas_bh:home_cas_rip), -(away_cas_bh:away_cas_rip))
}

data_tables <- map(data_tables, select_stats)

data_tables$Competitive %>% colnames()
```

# Comparing the races on a single statistic

Suppose we want to compare the 25+ Blood Bowl races on their match statistics with each other, and see which races have comparable stats.
If we have only one statistic, it is easy: we can just plot the races on a horizontal line and see which races are closest by.

Lets do that for the **number of blocks made**:

```{r}
res <- data_tables$Competitive %>% 
  group_by(race_name, race_type) %>% 
  summarise(avg_block = mean(home_block), size = n())

ggplot(res, aes(x = avg_block, y = 0, size = size, col = race_type)) +
         geom_point() +
scale_size_area()
```

But races can be similar if we look at **blocks**, but dissimilar if we look at e.g. **passing**. So lets add the average number of successful passes on the y axis.

(Note: The FUMBBL passing statistic is a "net" passing distance. It can also be negative, so races that pass "back" in the direction of their own touch down line can make many passes but still end up with a low average passing distance)

# completions vs blocking
```{r}
df_agg <- data_tables$Competitive %>% 
  group_by(race_name, race_type) %>% 
  summarise(avg_block = mean(home_block), 
            avg_comp = mean(abs(home_comp)),
            avg_foul = mean(home_foul),
            avg_pass = mean(abs(home_pass)), 
            avg_rush = mean(abs(home_rush)), 
            avg_cas_infl = mean(abs(home_cas)),
            avg_cas_rec = mean(abs(away_cas)), 
            
            size = n())

ggplot(df_agg, aes(x = avg_block, y = avg_comp, size = size, col = race_type)) +
         geom_point() +
  scale_size_area() +
  expand_limits(y=-0.5) +
  geom_label_repel(aes(label = race_name), size  = 2)
  

```

If we look at the **Human** team race,  we can see that, depending on how we weigh the relative importance (FOR WHAT) of blocks vs completions, there are three teams that are nearest to **Humans**:  **Imperial Nobility**,  **Old World Alliance**, and **Skaven**. 

Now with two statistics, we can simply plot them and calculate a distance between all points.
What if we have more than two statistics? E.g. we have 5 statistics? We have too many dimensions to plot.
Now in the plot above,there appears to be a negative correlation between passes and blocks. Teams that make more blocks tend to pass less.

However, there are also teams that do not conform: for example, the Goblin and Snotling races tend to make less blocks, but also less passes compared to other teams.

The passing (distance) statistic is surprisingly correlated with the number of succesfull passes.
The halflings are an exception, that can be explained by the combination of having Catchers (making passing more attractive), but also the Stunty trait, making low distance passes more risky. So the average passing distance is lower than other teams that pass at similar rates.

# passing vs completions

```{r}
res <- data_tables$Competitive %>% 
  group_by(race_name, race_type) %>% 
  summarise(avg_pass = mean(abs(home_pass)), 
            avg_comp = mean(home_comp), 
            size = n())

ggplot(res, aes(x = avg_pass, y = avg_comp, size = size, col = race_type)) +
         geom_point() +
  scale_size_area() +
  expand_limits(y=-0.5) +
  geom_label_repel(aes(label = race_name), size  = 2) +
  labs(x = "Averaged absolute net passing distance")
  
```
For rushes the same story holds as for passing distance, the direction of the rush is taken into account.

# rushing vs scoring

```{r}
res <- data_tables$Competitive %>% 
  group_by(race_name, race_type) %>% 
  summarise(avg_rush = mean(home_rush), 
            avg_score = mean(abs(team_score)), 
            size = n())

ggplot(res, aes(x = avg_rush, y = avg_score, size = size, col = race_type)) +
         geom_point() +
  scale_size_area() +
  expand_limits(y=-0.5) +
  geom_label_repel(aes(label = race_name), size  = 2)
  
```
Surprisingly, Skaven and UW lead in the average rushing distance metric. Check a few FUMBBL matches.
It turns out that rushing also includes movement with the ball.
So that is nice, the rushing metric quantifies mobility / speed of the teams, with Skaven's gutter runners (movement 9!) topping the charts, and the relatively slow ogres (movement 5) at the bottom.

From a post by SkiJunkie (the author of the predecessor of FUMBBL):
```
running/passing in the wrong direction counts negative. So if you run one step forward then one step back, your net rushing is 0.

Running/passing up and down neither adds nor subtracts. Getting pushed/thrown does not count. 
Only movement made during the players move who has the ball counts.

So, you can end up with negative rushing/passing. 
```

For these there exists so-called **dimensionality reduction techniques**.
In this blog post we'll examine two of them.

So we have for each combination of race and performance statistic (touchdowns, blocks etc) a value.

# fouling vs passing

```{r}
res <- data_tables$Competitive %>% 
  group_by(race_name, race_type) %>% 
  summarise(avg_pass = mean(home_pass), 
            avg_foul = mean(home_foul), 
            size = n())

ggplot(res, aes(x = avg_pass, y = avg_foul, size = size, col = race_type)) +
         geom_point() +
  scale_size_area() +
  expand_limits(y=-0.5) +
  geom_label_repel(aes(label = race_name), size  = 2)
  
```
```{r}
res <- data_tables$Competitive %>% 
  group_by(race_name, race_type) %>% 
  summarise(avg_block = mean(home_block), 
            avg_foul = mean(home_foul), 
            size = n())

ggplot(res, aes(x = avg_block, y = avg_foul, size = size, col = race_type)) +
         geom_point() +
  scale_size_area() +
  expand_limits(y=-0.5) +
  geom_label_repel(aes(label = race_name), size  = 2)
  
```

# Correlations between the variables

We can now either try to group the performance variables, this is about correlations between variables. Which variables are related to each other? 
This produces things like a correlation network graph. This is a poor mans factor analysis.
Alternatively, we can try to group the races: which races are close by? This is cluster analysis.

How can this be different whereas we simply can flip the dataset and have races as columns and performance stats as rows?

# Mutual information vs Pearson correlation

```{r}
library(infotheo)

data(USArrests)
dat <- infotheo::discretize(USArrests)
#computes the MIM (mutual information matrix)
I <- infotheo::mutinformation(dat, method = "emp")
#I2<- mutinformation(dat[,1],dat[,2])

I
#I2

cor(USArrests)
```


```{r}
library(qgraph)
cor_mat <- cor(data_tables$Competitive %>% 
                 select(-c(race_name, race_type)))

cor_mat


```
```{r}
qgraph(cor_mat, cut=0, layout="spring", 
       title="Correlation matrix", nodeNames = colnames(cor_mat))
```
```{r}
I <- mutinformation(data_tables$Competitive %>% 
                 select(-c(race_name, race_type)), method = "emp")
diag(I)
# mutinformation returns the mutual information I(X;Y) in nats.

qgraph(sqrt(I), cut=0, layout="spring", 
       title="Correlation matrix using MI", nodeNames = colnames(cor_mat), graph = "cor")
```
Variables that show strong relations:

* Home passes and home completions (you have to pass to make a completion)
* Away passes and away completions (you have to pass to make a completion)

* Home score and home rushing (movement with the ball)
* Away score and away rushing (movement with the ball)

* Home score and away score (if one team is scoring, the other team is not scoring)
* Blocks generates casualties (removals), and teams that block a lot have higher AV, leading to lower removals on their side

* Fouling

So the variables that hold independent information on the team are:

* Fouling (access to stunty, bribes etc)
* Blocking (vulnerability)
* Rushing (mobility, average movement of ball carriers)
* Passing (passing)

Individual variables: home fouls, away fouls, home cas, away cas, home blocks, away blocks.

Agile is a combination of running with the ball and passing. I.e. high elf more passing, skaven more running.

We can explain this if these variables are team properties, that do not depend on the opposing team, and on playing skill.
I.e. some teams are just teams that can foul more.

# Blood Bowl 2 performance statistics

The Cyanide Blood Bowl 2 API (not publicly accessible) apparently offers the following stats for each match, for both teams:

Scoring related:

* Ball occupation (not available in FUMBBL)
* Touchdowns
* Meters running (rushes)

Blocking related:

* Casualties
* Knock outs
* Injuries
* Dead

Passing related:

* Interceptions (not available in FUMBBL)
* Meters passing (passing yards)
* Passes (completions)

Fouling related:

* Expulsions (sent off players after fouling)
* FUMBBL: fouls (not available in BB2 API)

Other:

* Tackles (failed dodges?)


# Hierarchical clustering

```{r}
library(ggoheatmap)
```

```{r}
df_long <- df_agg %>%
  pivot_longer(cols = !c(race_name, race_type, size), names_to = "variable") %>%
  group_by(variable) %>%
  mutate(sd_value = scale(value))

df_long <- hclust_order(df_long, 
                        xvar = "race_name", 
                        yvar = "variable", 
                        value_var = "value",
                   clust_method = "complete",
                   dist_method = "euclidean")
df_long
```

```{r}
p1 <- ggplot(df_long, aes(x = reorder(race_name, cluster_order), y = 1, fill = race_type)) +
  geom_tile() + coord_flip() + labs(x = "", y = NULL) + scale_y_discrete(labels = NULL, breaks = NULL)

#p1
```
From the cluster analysis, Shambling Undead clearly is more similar to hybrid teams than to bash teams.
Khorne is a hybrid team (because of the lack of skills and frenzy reduces base contact and thus blocks).

Also underworld is positioned inbetween Snotling, Goblin and Skaven, and it is in fact a mix of those three teams!!

```{r}
p2 <- ggorder_heatmap(df_long, 
                xvar = "race_name", 
                yvar = "variable", 
                col_var = "sd_value", 
                order_var = "cluster_order",
                label_var = "value", round.digits = 1) + coord_flip() 
```

```{r fig.width= 15}
library(patchwork)

p <- p1 + p2 + plot_layout(widths = c(1, 6))



p + plot_annotation(title = 'BB2020 team typology')
```
Based on this plot, we conclude that both Black orcs and Khorne are hybrid teams, and that Undead and Underworld can be recategorized to Hybrid and Agile respectively.

# Related work 

Compare with master thesis 

http://www.diva-portal.org/smash/get/diva2:1480241/FULLTEXT01.pdf

https://www.diva-portal.org/smash/get/diva2:1541669/FULLTEXT02.pdf

SCHLICE, “Bash/dash/hybrid by the numbers.” https:
//www.nufflytics.com/post/bash-dash-hybrid-by-the-numbers/,
Feb 2018. Accessed on April 2020.

The nufflytics blog post has a somewhat surprising selection of match statistics.
For example, the number of inflicted touchdowns is selected, but not the number of sustained touchdowns.



