---
title: 'Analyzing world cup rosters using clustered heatmaps'
author: "Gertjan Verhoeven"
date: '2023-01-20'
bibliography: heatmap_post/2022_clusterheatmap_blog_post.json
summary: ""
slug: blood-bowl-world-cup
draft: no
categories:
- Blood Bowl
- Clustering
- Statistics
tags:
- R
- hclust
- heatmap
baseurl: https://gsverhoeven.github.io
header:
  image: headers/bb_heatmap_banner.png
  preview: no
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# outline

Blood Bowl as fantasy chess with dice. 
Describe Blood Bowl Tournament scene. 
The Previous World Cup in Dornbirn attracted 1400 coaches.
Estimate for coming WC is some 1500 coaches from Europe, US and Australia /New Zealand.

Unlike Chess, there is also a "Deck-building" phase were coaches have to form their team.
Bad choices in this phase will put you at a disadvantage even before the actual game has started.

Just as in other popular games with pre-game deck building, like Magic The Gathering, this automatically leads to a Meta game, where one has to prepare for choices that other coaches make. 

# Online Blood Bowl Tournaments on FUMBBL

Since all matches played online are recorded and available for replay, we can not only see which rosters tend to do well, we can even spectate particular matches and try and understand why they perform well.
The API exposes 

# Tournament selection

I found two FUMBBL resurrection tournaments using BB2020 rules that have sufficient volume AND have the chosen skills available (the first NAF online tournament GBFU using BB2020 rules somehow does not have this).

* Road to Malta
* Superleague

For preparation for the WC, the Road to Malta is the best, as its ruleset is almost identical to the WC (Except for tiering changes and PM). The superleague does not allow stars, making a big difference for e.g. Halfing, Underworld and OWA that competitively are typically played with Star players.

```{r}
# Load packages
library(tidyverse)
library(ggfortify)
library(ggrepel)
```

```{r}
df_matches <- read.csv(file = "../../../fumbbl_datasets/datasets/current/df_matches.csv")

df_matches$match_date <- as.Date(df_matches$match_date)
df_matches$week_date <- as.Date(df_matches$week_date)


df_mbt <- read.csv(file = "../../../fumbbl_datasets/datasets/current/df_mbt.csv")

df_mbt$match_date <- as.Date(df_mbt$match_date)
df_mbt$week_date <- as.Date(df_mbt$week_date)

```

```{r}
df_mbt %>%
  filter(division_name == "Competitive") %>%
 group_by(race_name, race_type) %>%
 summarise(n_mbt = n()) %>%
  arrange(-n_mbt)
```

```{r}
res <- df_matches %>%
  filter(year >= 2022) %>%
  group_by(division_name, league, division_id, tournament_id) %>%
  summarise(cnt = n()) %>%
  arrange(-cnt)

res
```
```{r}
# tournament id under competitive??
# Royal Rookie Rumble 491, onder groep 2294

# All New (meaning 0 Games) [Competitive] teams are eligible to apply. Your team will be accepted when there are 16 teams ready to rumble.
# Teams will be chosen on a "first come first serve" basis.
# Applied Teams which were not drawn in the last Tourney stay applied and need not to be reapplied. Your team will eventually be drawn in a RRR as long as it has 0 games played and has applied.


df_matches %>% filter(tournament_id == 56069)
```
```{r}
res <- df_matches %>%
  filter(league == 9298) %>%
  group_by(division_name, tournament_id, division_id, league, ruleset) %>%
  summarise(cnt = n(), start_date = min(match_date), end_date = max(match_date)) %>%
  arrange(-tournament_id)

res
```

# Teams selection: identify 1150K tournaments

```{r}
df_matches$tv_1150 <- 0

df_matches[df_matches$tv_match == 1150, ]$tv_1150 <- 1
```

```{r}
df_matches %>%
  group_by(division_name, tournament_id, division_id, league, ruleset, tournament_name) %>%
  summarise(cnt = n(), 
            perc = mean(tv_1150),
            start_date = min(match_date), 
            end_date = max(match_date)) %>%
  filter(perc > 0.7) %>%
  mutate(full_name = paste(division_name, " --", tournament_name)) %>%
  ungroup() %>%
  select(full_name, tournament_id, league, perc, cnt, start_date, end_date) %>%
  arrange(-cnt)
```

This looks good. "German Eurobowl team" has become "World cup training".


# Teams selection: identify 1100K tournaments

```{r}
df_matches$tv_1100 <- 0

df_matches[df_matches$tv_match == 1100, ]$tv_1100 <- 1
```

```{r}
df_matches %>%
  group_by(division_name, tournament_id, division_id, league, ruleset, tournament_name, year) %>%
  summarise(cnt = n(), 
            perc = mean(tv_1100),
            start_date = min(match_date), 
            end_date = max(match_date)) %>%
  filter(perc > 0.7) %>%
  mutate(full_name = paste(division_name, " --", tournament_name)) %>%
  ungroup() %>%
  select(full_name, tournament_id, league, perc, cnt, start_date, end_date) %>%
  arrange(-cnt)
```

# Check Alicante world cup training teams

```{r}
res <- df_matches %>% filter(league == 9941 & year > 2021) %>% group_by(week_date, year) %>% summarise(n(), avg_team = mean(team1_id), var_team = sd(team1_id))

ggplot(res, aes(x = week_date, y = avg_team)) +
  geom_point() +
  geom_point(aes(y = var_team*100), col = "red")
```
```{r}
max(unique(c(df_matches %>% filter(league == 9941 & week_date == as.Date("2022-11-21")) %>%
  pull(team1_id), df_matches %>% filter(league == 9941 & week_date == as.Date("2022-11-21")) %>%
  pull(team2_id))))
```
Conclusion not enough WC teams to analyse, we analyse EB instead.

Super league has 400+ matches, try that one
league is 15615



```{r}
res <- df_matches %>%
  filter(league == 15615 & year > 2021) %>%
  group_by(division_name, league, division_id, tournament_id) %>%
  summarise(cnt = n()) %>%
  arrange(-cnt)

res
```


Of world cup training (bevat vooral EB teams, kunnen filteren op team value) of op datum oid.
Is ergens in november geswitched. Heel 2022 was het EB training. Moeten even kijken naar # skills.

# References



