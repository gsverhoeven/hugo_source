---
title: 'Analyzing world cup rosters using clustered heatmaps'
author: "Gertjan Verhoeven"
date: '2023-01-20'
bibliography: heatmap_post/2022_clusterheatmap_blog_post.json
summary: ""
slug: blood-bowl-world-cup
draft: no
categories:
- Blood Bowl
- Clustering
- Statistics
tags:
- R
- hclust
- heatmap
baseurl: https://gsverhoeven.github.io
header:
  image: headers/bb_heatmap_banner.png
  preview: no
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Read and prep the data

We start with reading in the scraped FUMBBL match data, see my previous blog posts mentioned above for details.

```{r warning=FALSE, message=FALSE}
# Load packages
library(tidyverse)
library(ggfortify)
library(ggrepel)
```


# Create heatmap plots for Road to Malta

```{r}
df_rosters <- read.csv(file = "../../../fumbbl_datasets/datasets/current/df_rosters_road_to_malta.csv")

df_rosters <- df_rosters %>%
  filter(position != "") %>%
  mutate(cnt = 1) %>%
  rename(skill_name = name)
```

```{r}
# add xtra stuff
extra_stuff <- unique(df_rosters %>% 
                    mutate(apothecary = ifelse(apothecary == "Yes", 1, 0)) %>%
  select(team_id, roster.name, coach_name, rerolls, assistantCoaches, cheerleaders, apothecary) %>%
    pivot_longer(cols = -c(team_id, roster.name, coach_name), values_to = "cnt") %>%
    filter(cnt > 0) %>%
    mutate(position = name) %>%
    select(team_id, roster.name, coach_name, position, cnt) %>%
    mutate(player_id = 99999999) %>%
    mutate(number = 99) %>%
    mutate(skill_id = NA) %>%
    mutate(name = NA)) %>%
    rename(skill_name = name)

df_rosters <- df_rosters %>%
  select(-c(X, rerolls, assistantCoaches, cheerleaders, apothecary))

df_rosters <- rbind(df_rosters, extra_stuff)

# PM wrangle bribes into cnt 0-3 bribes
```

```{r}
# PM remove 15073041 extra row without extra skill
```

# Cleanup the skill names

```{r}
df_rosters <- df_rosters %>%
  mutate(skill_name = str_replace_all(skill_name, 
            pattern = "^_", replacement = "")) %>%
  mutate(skill_name = replace_na(skill_name, ""))
```


# condense skill stacking rows

```{r}
df_rosters <- df_rosters %>%
  arrange(player_id, -skill_id) %>%
  group_by(across(c(-skill_id, -skill_name))) %>%
  summarise(skill_name = paste(skill_name, collapse = ""))

skill_colors <- df_rosters %>%
  group_by(skill_name) %>%
  summarise(n = n())
```

# create color table

```{r}
library(readODS)
#write_ods(skill_colors, "fumbbl_rosters_post/skill_colors.ods")

skill_colors <- read_ods("fumbbl_rosters_post/bb_skill_colors.ods")

skill_colors <- skill_colors %>%
  mutate(skill_name = replace_na(skill_name, "")) %>%
  select(-n)
```


# create code list with cost info

create empty list with all roster positions for each race
```{r}

out <- df_rosters %>%
  group_by(position, roster.name) %>%
  summarise(n = n())

#write_ods(out, "fumbbl_rosters_post/bb_rosters.ods")
```
manually fill in cost and sort order

# add codelist

```{r}
cost <- read_ods("fumbbl_rosters_post/bb_rosters_cost.ods")

cost <- cost %>%
  select(-n)
```

```{r}
df_rosters <- df_rosters %>%
  left_join(cost, by = c("position", "roster.name"))
```

# Check team cost

```{r}


res <- df_rosters %>%
  mutate(tot_cost = cnt * cost) %>%
  group_by(player_id, team_id, position, coach_name, roster.name, tot_cost) %>% # remove two rows per player (skill stacking)
  summarise() %>%
  group_by(team_id, coach_name, roster.name) %>%
  summarise(team_cost = sum(tot_cost)) %>%
  filter(!is.na(team_cost ))

res %>% filter(team_cost > 1150)

```

all teams with 50 or 100 extra, remove 1 bribe (get the ref ends up on the match page)

```{r}
teams_get_the_ref <- res %>%
  filter(team_cost > 1150) %>%
  ungroup() %>%
  distinct(team_id) %>%
  pull()
```

```{r}
# remove the get the ref bribes

df_rosters <- df_rosters %>%
  filter(!(team_id %in% teams_get_the_ref & grepl("bribe", position)))
```

# Check nog een keer de cost

```{r}


res <- df_rosters %>%
  mutate(tot_cost = cnt * cost) %>%
  group_by(player_id, team_id, position, coach_name, roster.name, tot_cost) %>% # remove two rows per player (skill stacking)
  summarise() %>%
  group_by(team_id, coach_name, roster.name) %>%
  summarise(team_cost = sum(tot_cost)) %>%
  filter(!is.na(team_cost ))

summary(res$team_cost)

```

```{r}
res %>% filter(team_cost < 1135)
```


```{r}
df_rosters <- df_rosters %>%
  left_join(skill_colors, by = "skill_name")
```


# prep data for heatmap

```{r message = F, fig.width= 10}
race_name <- "Skaven"
race_name <- "Shambling Undead"
race_name <- "Chaos Dwarf"
race_name <- "Human"
race_name <- "Chaos Renegade"
race_name <- "Dark Elf"
race_name <- "Dwarf"
race_name <- "Elven Union"
race_name <- "Goblin"
race_name <- "Halfling"
race_name <- "Vampire"
race_name <- "Underworld Denizens"
#race_name <- "Lizardmen"

races <- unique(df_rosters$roster.name)

for(i in 1:length(races)){
  race_name <- races[i]

  df <- df_rosters %>% 
    filter(roster.name == race_name) %>%
    filter(!(position %in% c("cheerleaders", "assistantCoaches"))) %>%
    group_by(team_id, coach_name, player_id, position, sort_order, number, skill_name, color) %>% # skill stacking
    summarise(cnt = max(cnt)) %>%
    group_by(team_id, coach_name, player_id, position, sort_order, skill_name, color) %>%
    summarise(n = sum(cnt)) %>%
    group_by(team_id, coach_name, position, sort_order, n) %>%
    summarise(nr = row_number(), skill_name = skill_name, color = color)
  
  
  gp <- ggplot(df, aes(x = factor(coach_name), y = reorder(paste(position, nr), -sort_order))) +
    geom_tile(aes(fill = color), color = "black") +
    geom_text(aes(label = n), color = "white") +
    scale_fill_identity(name = "Skills",
                        breaks = c(skill_colors$color),
                        labels = c(skill_colors$skill_name),
                        guide = "legend") +
    #scale_fill_gradient(low = "light blue", high = "blue", na.value = "white") +
    coord_fixed() +
    #theme(legend.position = "none") +
    ggtitle(paste0("FUMBBL Road to Malta 2022 ", race_name, " rosters")) + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    theme(panel.background = element_rect(fill = "white")) +
    labs(x = "Coach_name", y = "")
  
  plotname <- paste0("fumbbl_rosters_post/eb2022_position_plot_", race_name, ".png")
  print(plotname)
  ggsave(plotname, gp)
}
```
PM Daar kunnen we clustering op doen.

PM standings er aan koppelen.


```{r}
df_matches <- read.csv(file = "../../../fumbbl_datasets/datasets/current/df_matches.csv")

df_matches$match_date <- as.Date(df_matches$match_date)
df_matches$week_date <- as.Date(df_matches$week_date)


df_mbt <- read.csv(file = "../../../fumbbl_datasets/datasets/current/df_mbt.csv")

df_mbt$match_date <- as.Date(df_mbt$match_date)
df_mbt$week_date <- as.Date(df_mbt$week_date)

```

```{r}
df_mbt %>%
  filter(division_name == "Competitive") %>%
 group_by(race_name, race_type) %>%
 summarise(n_mbt = n()) %>%
  arrange(-n_mbt)
```

```{r}
res <- df_matches %>%
  #filter(division_name == "Competitive") %>%
  group_by(week_date, division_name, tournament_id) %>%
  summarise(cnt = n())

ggplot(res , aes(x = week_date, y = cnt, col = division_name)) +
  geom_point() +
  geom_line() +
    theme(legend.position = "none") 
```
```{r}
# tournament id under competitive??
# Royal Rookie Rumble 491, onder groep 2294

# All New (meaning 0 Games) [Competitive] teams are eligible to apply. Your team will be accepted when there are 16 teams ready to rumble.
# Teams will be chosen on a "first come first serve" basis.
# Applied Teams which were not drawn in the last Tourney stay applied and need not to be reapplied. Your team will eventually be drawn in a RRR as long as it has 0 games played and has applied.


df_matches %>% filter(tournament_id == 56069)
```
```{r}
res <- df_matches %>%
  filter(league == 9298) %>%
  group_by(division_name, tournament_id, division_id, league, ruleset) %>%
  summarise(cnt = n(), start_date = min(match_date), end_date = max(match_date)) %>%
  arrange(-tournament_id)

res
```

# Teams selection: identify 1150K tournaments

```{r}
df_matches$tv_1150 <- 0

df_matches[df_matches$tv_match == 1150, ]$tv_1150 <- 1
```

```{r}
df_matches %>%
  group_by(division_name, tournament_id, division_id, league, ruleset, tournament_name) %>%
  summarise(cnt = n(), 
            perc = mean(tv_1150),
            start_date = min(match_date), 
            end_date = max(match_date)) %>%
  filter(perc > 0.7) %>%
  mutate(full_name = paste(division_name, " --", tournament_name)) %>%
  ungroup() %>%
  select(full_name, tournament_id, league, perc, cnt, start_date, end_date) %>%
  arrange(-cnt)
```

This looks good. "German Eurobowl team" has become "World cup training".


# Teams selection: identify 1100K tournaments

```{r}
df_matches$tv_1100 <- 0

df_matches[df_matches$tv_match == 1100, ]$tv_1100 <- 1
```

```{r}
df_matches %>%
  group_by(division_name, tournament_id, division_id, league, ruleset, tournament_name, year) %>%
  summarise(cnt = n(), 
            perc = mean(tv_1100),
            start_date = min(match_date), 
            end_date = max(match_date)) %>%
  filter(perc > 0.7) %>%
  mutate(full_name = paste(division_name, " --", tournament_name)) %>%
  ungroup() %>%
  select(full_name, tournament_id, league, perc, cnt, start_date, end_date) %>%
  arrange(-cnt)
```

# Check Alicante world cup training teams

```{r}
res <- df_matches %>% filter(league == 9941 & year > 2021) %>% group_by(week_date, year) %>% summarise(n(), avg_team = mean(team1_id), var_team = sd(team1_id))

ggplot(res, aes(x = week_date, y = avg_team)) +
  geom_point() +
  geom_point(aes(y = var_team*100), col = "red")
```
```{r}
max(unique(c(df_matches %>% filter(league == 9941 & week_date == as.Date("2022-11-21")) %>%
  pull(team1_id), df_matches %>% filter(league == 9941 & week_date == as.Date("2022-11-21")) %>%
  pull(team2_id))))
```
Conclusion not enough WC teams to analyse, we analyse EB instead.


# References



